<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="roomdoo_menu_link_active" inherit_id="website.submenu">
        <xpath expr="//a[@t-att-href='submenu.clean_url()']" position="attributes">
            <attribute name="t-attf-class">#{link_class or ''} #{'active' if submenu.clean_url() and unslug_url(request.httprequest.path) == unslug_url(submenu.clean_url()) or submenu.clean_url() == '/reservation/list' and unslug_url(request.httprequest.path).startswith('/reservation/') else ''}</attribute>
        </xpath>
    </template>
    <template id="roomdoo_reservation_detail" name="Reservation detail">
        <t t-call="website.layout">
            <t t-set="page_title" t-value="'Reservation detail'" />
            <t t-call="pms_pwa.o_pms_pwa_edit_modal" />
            <input type="hidden" name="reservation_id" t-attf-value="{{ reservation.id }}" />
            <div class="o_pms_pwa_roomdoo_reservation_modal" />
            <div class="o_pms_pwa_notifications o_pms_pwa_notifications_regular mt-4 row">
                <span class="o_pms_notification_title col-2">
                    <i class="fa fa-info-circle mr-1"/> Actualizaciones <span class="o_pms_pwa_update_counter ml-1"/>
                </span>
                <div class="col-9 o_pms_pwa_notification_list"/>
                <a href="#" class="col-1 btn o_pms_pwa_btn_border o_pms_pwa_clear_all float-right">Aceptar todo</a>
            </div>
            <div class="o_pms_pwa_roomdoo_alerts" />
            <div id="o_pms_detail_reservation" class="oe_structure o_pms_pwa_structure mt-2">
                <section class="container-fluid o_pms_pwa_roomdoo">
                    <div class="justify-content-center ">
                        <div class="row ">
                            <div class="col-lg-12 col-xl-6">
                                <h1>
                                    <span class="title-header">
                                        <t t-if="reservation.pms_property_id" t-esc="reservation.pms_property_id.display_name"/>
                                    </span>
                                    <span class="blue-header">
                                        <t t-esc="reservation.name" />
                                    </span>
                                    <span class="agency">
                                        <img t-if="reservation.agency_id" t-att-src="website.image_url(reservation.agency_id, 'image_128')" width="100" t-att-title="reservation.agency_id.name" t-att-alt="reservation.agency_id.name" />
                                        <span t-else="">
                                            <span t-if="reservation.channel_type_id" t-esc="reservation.channel_type_id.name" />
                                            <span t-if="reservation.channel_type_id" class="o_pms_pwa_wler ml-2" t-esc="reservation.user_id.name" />
                                        </span>

                                    </span>
                                    <span class="status-header">
                                        <t t-esc="reservation.state" />
                                    </span>
                                </h1>
                            </div>
                            <div class="col-lg-12 col-xl-6 text-right o_pms_pwa_keypad_footer">
                                <button id="o_pms_pwa_button_checkins" t-attf-data-id="{{ reservation.id }}" t-attf-url="/reservation/{{ reservation.id }}/checkin" class="btn btn-grey-300 btn-radius o_pms_pwa_button_checkins o_pms_pwa_disabled">Check in</button>
                                <button id="o_pms_pwa_button_checkout" t-attf-data-id="{{ reservation.id }}" t-attf-url="/reservation/{{ reservation.id }}/checkout" class="btn btn-grey-300 btn-radius o_pms_pwa_button_checkout o_pms_pwa_disabled">Check out</button>
                                <span class="dropdown ml-3">
                                    <a role="button" class="btn btn-secondary dropdown-toggle btn-radius" style="background-color: #01b6e3 !important; border: none;" data-toggle="dropdown" href="#" >Otras opciones</a>
                                    <div class="dropdown-menu" aria-labelledby="dLabel">
                                        <button id="o_pms_pwa_button_new_reservation" class="dropdown-item o_pms_pwa_abutton o_pms_pwa_button_new_reservation" t-attf-data-folio_id="{{ reservation.folio_id.id }}" type="button">Añadir habitación</button>
                                        <button id="o_pms_pwa_button_cancelar" t-attf-data-id="{{ reservation.id }}" t-attf-url="/reservation/{{ reservation.id }}/cancel" class="dropdown-item o_pms_pwa_abutton o_pms_pwa_button_cancelar">Cancel booking</button>
                                    </div>
                                </span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 col-xl-4  mt-4">
                                <div t-if="reservation.folio_id.number_of_rooms > 1" class="card mb-4 shadow">
                                    <div class="o_pms_pwa_table_reservation_list m-4">
                                        <table class="table table-condensed">
                                            <thead>
                                                <tr>
                                                    <th class="o_pms_pwa_theme_color"></th>
                                                    <th class="o_pms_pwa_theme_color">ID</th>
                                                    <th class="o_pms_pwa_theme_color">Total</th>
                                                    <th class="o_pms_pwa_theme_color">Name</th>
                                                    <th class="o_pms_pwa_theme_color">Type</th>
                                                    <th class="o_pms_pwa_theme_color">nº</th>
                                                </tr>

                                            </thead>
                                            <tbody>
                                                <t t-foreach="reservation.folio_id.reservation_ids" t-as="i">
                                                    <tr t-att-class="'o_roomdoo_hide_show '
                                                        + ('o_pms_pwa_background_grey' if reservation.id == i.id else ' ')">
                                                        <td>
                                                            <input type="checkbox" name="reservation_ids" checked="checked" t-if="reservation.id == i.id" t-attf-value="{{ i.id }}" />
                                                            <input type="checkbox" name="reservation_ids" t-if="reservation.id != i.id" t-attf-value="{{ i.id }}" />
                                                        </td>
                                                        <td>
                                                            <a t-att-href="'/reservation/' + str(i.id)">
                                                                <t t-esc="i.name" />
                                                            </a>
                                                        </td>
                                                        <td class="text-right">
                                                            <t t-esc="i.price_total" />
                                                        </td>
                                                        <td>
                                                            <t t-esc="i.partner_id.name" />
                                                        </td>
                                                        <td class="text-right">
                                                            <t t-esc="i.room_type_id.default_code" />
                                                        </td>
                                                        <td>
                                                            <t t-esc="i.preferred_room_id.name" />
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>

                                        <div class="row">
                                            <div class="col-12 mt-2">
                                                <div class="o_roomdoo_hide_show-more">Ver más</div>
                                            </div>
                                        </div>

                                    </div>

                                </div>
                                <div class="card shadow">
                                    <div class="container-fluid">
                                        <div class="bg-dark">
                                            <div class="row">
                                                <div class="col-12">
                                                    <img class="ml-4 my-4 rounded-circle img-fluid o_pms_pwa_img_rounded" t-att-src="website.image_url(reservation, 'partner_image_128')" t-att-title="reservation.partner_name" t-att-alt="reservation.partner_name" width="100" style="background-color: white;"/>
                                                </div>
                                                <div class="col-12">
                                                    <h3 class="text-white ml-4">
                                                        <t t-esc="reservation.partner_name" />
                                                    </h3>
                                                    <p t-if="reservation.mobile" class="ml-4 mb-0">
                                                        <a t-attf-href="tel:{{reservation.mobile}}" class="text-white">
                                                            <t t-esc="reservation.mobile" />
                                                        </a>
                                                    </p>
                                                    <p t-if="reservation.email" class="ml-4">
                                                        <a t-attf-href="mailto:{{reservation.email}}" class="text-white font-italic">
                                                            <t t-esc="reservation.email" />
                                                        </a>
                                                    </p>
                                                </div>
                                            </div>
                                            <div clas="row">
                                                <div class="col-12">
                                                    <div class="progress o_pms_pwa_progress mx-2">
                                                        <div t-att-class="'progress-bar '
                                                            + ('bg-success ' if reservation.state in ('onboard') else ' ')
                                                            + ('bg-light ' if reservation.state in ('done', 'cancel', 'no_show', 'no_checkout') else ' ')
                                                            + ('bg-success ' if reservation.state in ('confirm') and reservation.ratio_checkin_data &gt; 75 else ' ')
                                                            + ('bg-warning ' if reservation.state in ('confirm') and  75 &gt; reservation.ratio_checkin_data &gt; 50 else ' ')
                                                            + ('bg-danger ' if reservation.state in ('confirm') and  reservation.ratio_checkin_data &lt; 50 else ' ')" role="progressbar" t-att-style="'width:'+ str(reservation.checkins_ratio if reservation.state in ('onboard') else reservation.ratio_checkin_data) + '%'" t-att-aria-valuenow="reservation.checkins_ratio if reservation.state in ('onboard') else reservation.ratio_checkin_data" aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    <div class="dropdown mx-2">
                                                        <button class="btn btn-persona-info dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                            <span data-toggle="tooltip" title="Guest personal data" class="badge bg-black mr-2" data-original-title="Guest personal data">
                                                                <t t-esc="reservation.adults" />
                                                            </span>
                                                            Huéspedes
                                                        </button>
                                                        <div class="dropdown-menu btn-persona-info-item" aria-labelledby="dropdownMenuButton">
                                                            <t t-foreach="reservation.checkin_partner_ids" t-as="person">
                                                                <a class="dropdown-item o_pms_pwa_button_checkins" t-attf-data-id="{{ reservation.id }}" t-attf-url="/reservation/{{ reservation.id }}/checkin" t-attf-data-target="#checkin_partner_{{person.id}}">
                                                                    <t t-if="person.firstname">
                                                                        <t t-esc="person.firstname" /> <t t-esc="person.lastname" />
                                                                    </t>
                                                                    <t t-else="">
                                                                        Introducir datos del huésped
                                                                    </t>
                                                                </a>
                                                            </t>
                                                        </div>
                                                    </div>
                                                    <!-- <button url="/print-checkin" type="button" t-attf-data-id="{{reservation.id}}" class="o_pms_pwa_button_print_checkin btn btn-block btn-grey-300 btn-radius o_pms_pwa_50w" data-dismiss="modal" aria-label="Print checkin">
                                                        <span>Print checkin</span>
                                                    </button>
                                                     -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="box o_pms_pwa_direct_chat o_pms_pwa_direct_chat_warning">
                                            <!-- <div class="box-header with-border">
                                                <h3 class="box-title">Mensajes</h3>
                                                <div class="box-tools pull-right">
                                                    <span data-toggle="tooltip" title="New Messages" class="badge o_pms_pwa_bg_blue" data-original-title="New Messages"><t t-esc="reservation.message_unread_counter"></t></span>
                                                </div>
                                            </div> -->
                                            <div id="o_pms_pwa_direct_chat_messages" class="box-body">
                                                <div class="o_pms_pwa_direct_chat_messages">
                                                    <t t-set="mesage_date" t-value="[]" />
                                                    <t t-foreach="reservation.message_ids.sorted(key=lambda x: x.date)" t-as="msg">
                                                        <t t-if="msg.date not in mesage_date" t-set="mesage_date" t-value="mesage_date+[msg.date]" />
                                                    </t>
                                                    <t t-foreach="mesage_date" t-as="date">
                                                        <div class="o_pms_pwa_direct_chat_timestamp text-center">
                                                            <strong t-esc="date" t-esc-options='{"format": "%d %B %Y"}'/>
                                                        </div>
                                                        <t t-foreach="reservation.message_ids.sorted(key=lambda x: x.date)" t-as="msg">
                                                            <t t-if="date==msg.date">
                                                                <div class="o_pms_pwa_direct_chat_msg m-2">
                                                                    <div class="o_pms_pwa_direct_direct_chat_info clearfix">
                                                                        <span class="pull-left">
                                                                            <img class="o_pms_pwa_direct_chat_img rounded-circle img-fluid" t-att-src="website.image_url(msg.author_id, 'image_128')" t-att-title="reservation.partner_id.name" t-att-alt="reservation.partner_id.name" />
                                                                            <strong class="ml-2">
                                                                                <t t-esc="msg.author_id.name"></t>
                                                                            </strong>
                                                                        </span>
                                                                        <span class="o_pms_pwa_direct_chat_timestamp pull-right">
                                                                            <span t-field="msg.date" t-options='{"format": "H:s"}' />
                                                                        </span>
                                                                    </div>

                                                                    <div class="o_pms_pwa_direct_chat_text">
                                                                        <span t-field="msg.body" options="{'style-inline': true}" />
                                                                    </div>
                                                                </div>
                                                            </t>
                                                        </t>
                                                    </t>
                                                </div>
                                            </div>
                                            <div class="box-footer text-center">
                                                <form action="/reservation/82" name="reservation_detail_form" method="post">
                                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
                                                    <input type="hidden" name="model" value="pms.reservation" />
                                                    <input type="hidden" name="id" t-att-value="reservation.id" />
                                                    <input type="hidden" name="folio_id" t-att-value="reservation.folio_id.id" />
                                                    <div class="form-group">
                                                        <input type="text" name="message" placeholder="Escribe..." class="form-control message-input" required="" />
                                                        <input type="submit" class="btn btn-message" value="Enviar" />
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12 col-xl-4 mt-4" id="folio_reservation_ids">
                                <div class="card shadow">
                                    <div class="card-header bg-white o_pms_pwa_card_header">
                                        <h3 class="mb-0">
                                            ROOM
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <form t-attf-action="/reservation/{{reservation.id}}" method="post" class="form-horizontal" id="reservation_detail">
                                            <div class="form-group form-field mt8">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <label class="control-label col-12" for="room_type_id">
                                                            Room type
                                                        </label>
                                                        <select
                                                            t-att-disabled='"disabled" if "room_type_id" in readonly_fields else None'
                                                            t-att-required='"required" if "room_type_id" in required_fields else None'
                                                            class="form-control o_website_form_input o_domain_leaf_operator_select o_input" name="room_type_id"
                                                            style="cursor:pointer;">
                                                            <t t-foreach="json_reservation['room_types']" t-as="i">
                                                                <option name="room_type_id" t-att-value="i['id']" selected="selected" t-if="json_reservation['room_type_id']['id'] == i['id']">
                                                                    <t t-esc="i['name']" />
                                                                </option>
                                                                <option name="room_type_id" t-att-value="i['id']" t-if="json_reservation['room_type_id']['id'] != i['id']">
                                                                    <t t-esc="i['name']" />
                                                                </option>
                                                            </t>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <label class="control-label col-12" for="preferred_room_id">
                                                            Room number
                                                        </label>
                                                        <select
                                                            t-att-disabled='"disabled" if "preferred_room_id" in readonly_fields else None'
                                                            t-att-required='"required" if "preferred_room_id" in required_fields else None'
                                                            class="form-control o_website_form_input o_domain_leaf_operator_select o_input" name="preferred_room_id"
                                                            style="cursor:pointer;">
                                                            <t t-foreach="json_reservation['room_numbers']" t-as="i">
                                                                <option name="preferred_room_id" t-att-value="i['id']" selected="selected" t-if="json_reservation['preferred_room_id']['id'] == i['id']">
                                                                    <t t-esc="i['name']" />
                                                                </option>
                                                                <option name="preferred_room_id" t-att-value="i['id']" t-if="json_reservation['preferred_room_id']['id'] != i['id']">
                                                                    <t t-esc="i['name']" />
                                                                </option>
                                                            </t>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-6">
                                                        <label class="control-label col-12" for="adults">
                                                            People
                                                        </label>
                                                        <input
                                                            t-att-required='"required" if "adults" in required_fields else None'
                                                            t-att-readonly='"readonly" if "adults" in readonly_fields else None'
                                                            class="form-control" type="text" name="adults" t-att-value="json_reservation['adults']" />
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="control-label col-12" for="nights">
                                                            Nights
                                                        </label>
                                                        <input
                                                            t-att-required='"required" if "nights" in required_fields else None'
                                                            t-att-readonly='"readonly" if "nights" in readonly_fields else None'
                                                            class="form-control" disabled="disabled" type="text" name="nights" t-att-value="json_reservation['nights']" />
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <!-- <t t-if="lang and lang == 'es_ES'">
                                                            <t t-set="checkin_date" t-value="json_reservation['checkin'].strftime('%d/%m/%Y')"/>
                                                            <t t-set="checkout_date" t-value="json_reservation['checkout'].strftime('%d/%m/%Y')"/>
                                                        </t>
                                                        <t t-else=""> -->
                                                        <t t-set="checkin_date" t-value="json_reservation['checkin']"/>
                                                        <t t-set="checkout_date" t-value="json_reservation['checkout']"/>
                                                        <!-- </t> -->
                                                        <label class="control-label col-12" for="range_check_date_detail_reservation">
                                                            Check in - Check out
                                                        </label>
                                                        <input class="form-control" type="text" name="range_check_date_detail_reservation" t-attf-value="{{ checkin_date }} - {{ checkout_date }}" style="cursor:pointer;"/>
                                                        <span class="o_pms_pwa_calendar_icon">
                                                            <!-- <span class="fa fa-calendar" /> -->
                                                            <img src="/pms_pwa/static/img/svg/calendario-azul.svg" alt="calendar icon" title="calendar" width="20" />
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-6">
                                                        <input type="hidden" name="checkin" t-attf-value="{{ checkin_date }}" />
                                                        <input type="hidden" name="checkout" t-attf-value="{{ checkout_date }}" />
                                                        <label class="control-label col-12" for="check_in_hour">
                                                            Check in time
                                                        </label>
                                                        <input
                                                            t-att-required='"required" if "arrival_hour" in required_fields else None'
                                                            t-att-readonly='"readonly" if "arrival_hour" in readonly_fields else None'
                                                            class="form-control" type="time" name="arrival_hour" t-att-value="json_reservation['arrival_hour']" />
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="control-label col-12" for="check_out_hour">
                                                            Check out time
                                                        </label>
                                                        <input
                                                            t-att-required='"required" if "departure_hour" in required_fields else None'
                                                            t-att-readonly='"readonly" if "departure_hour" in readonly_fields else None'
                                                            class="form-control" type="time" name="departure_hour" t-att-value="json_reservation['departure_hour']" />
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-sm-6">
                                                        <label class="control-label col-12" for="allowed_reservation_types">
                                                            Reservation type
                                                        </label>
                                                        <select
                                                            t-att-disabled='"disabled" if "board_service_room_id" in readonly_fields else None'
                                                            t-att-required='"required" if "board_service_room_id" in required_fields else None'
                                                            class="form-control o_website_form_input o_domain_leaf_operator_select o_input" name="reservation_type"
                                                            style="cursor:pointer;">
                                                            <t t-foreach="json_reservation['reservation_types']" t-as="key">
                                                                <t t-if="key['id'] == json_reservation['reservation_type']">
                                                                    <option name="reservation_type" t-att-value="key['id']" selected="selected">
                                                                        <t t-esc="key['name']" />
                                                                    </option>
                                                                </t>
                                                                <t t-else="">
                                                                    <option name="reservation_type" t-att-value="key['id']">
                                                                        <t t-esc="key['name']" />
                                                                    </option>
                                                                </t>
                                                            </t>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label class="control-label col-12" for="allowed_board_service_room_ids">
                                                            Servicios
                                                        </label>
                                                        <select
                                                            t-att-disabled='"disabled" if "board_service_room_id" in readonly_fields else None'
                                                            t-att-required='"required" if "board_service_room_id" in required_fields else None'
                                                            class="form-control o_website_form_input o_domain_leaf_operator_select o_input" name="board_service_room_id"
                                                            style="cursor:pointer;">
                                                            <t t-foreach="json_reservation['allowed_board_service_room_ids']" t-as="key">
                                                                <t t-if="key['id'] == json_reservation['board_service_room_id']['id']">
                                                                    <option name="board_service_room_id" t-att-value="key['id']" selected="selected">
                                                                        <t t-esc="key['name']" />
                                                                    </option>
                                                                </t>
                                                                <t t-else="">
                                                                    <option name="board_service_room_id" t-att-value="key['id']">
                                                                        <t t-esc="key['name']" />
                                                                    </option>
                                                                </t>
                                                            </t>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="row m-3" id="o_pms_pwa_services_line">

                                                    <t t-foreach="reservation.service_ids" t-as="i">
                                                        <input type="hidden" t-attf-name="o_pms_pwa_service_line_{{i.id}}" t-attf-value="{{i.id}}"/>
                                                        <div class="col-12">
                                                            <div class="form-check mt-2" t-if="i.service_line_ids">
                                                                <input class="o_pms_pwa_checkbox" type="checkbox" checked="checked" t-attf-data-service_id="{{i.id}}" t-attf-id="defaultCheck{{i.id}}" data-toggle='collapse' t-attf-data-target='#collapsediv{{i.id}}' aria-expanded="true" t-attf-aria-controls="collapsediv{{i.id}}" />
                                                                <label class="o_pms_pwa_checkbox_label" t-attf-for="defaultCheck{{i.id}}">
                                                                    <t t-esc="i.product_id.name" />
                                                                </label>
                                                                <div t-attf-id='collapsediv{{i.id}}' class='o_pms_pwa_collapse collapse show'>
                                                                    <div class="o_pms_pwa_collapse_content mt-3">
                                                                        <br />
                                                                        <table>
                                                                            <thead>
                                                                                <tr>
                                                                                    <th class="o_pms_pwa_detail_th">Date</th>
                                                                                    <th class="o_pms_pwa_detail_th">Quantity</th>
                                                                                    <th class="o_pms_pwa_detail_th">Price</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                <t t-foreach="i.service_line_ids" t-as="s" >
                                                                                    <tr t-attf-class="o_roomdoo_hide_show_service_{{i.id}}">
                                                                                        <td class="o_pms_pwa_detail_td">
                                                                                            <span t-field="s.date" />
                                                                                        </td>
                                                                                        <td class="o_pms_pwa_detail_td o_pms_pwa_td_rb">
                                                                                            <div class="o_pms_pwa_rb_box">
                                                                                                <div class="o_pms_pwa_rb">
                                                                                                    <div class="o_pms_pwa_rb_tab o_pms_pwa_rb_remove" t-attf-data-reservation-id="{{ reservation.id }}" t-attf-data-service-id="{{ i.id }}" t-attf-data-id="{{ s.id }}">
                                                                                                        <div class="o_pms_pwa_rb_spot">
                                                                                                            <span class="o_pms_pwa_rb_txt">
                                                                                                                X
                                                                                                            </span>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="o_pms_pwa_rb_tab o_pms_pwa_rb_tab_active">
                                                                                                        <div class="o_pms_pwa_rb_spot">
                                                                                                            <span t-attf-class="o_pms_pwa_rb_txt o_pms_pwa_rb_value_{{s.id}}">
                                                                                                                <t t-esc="s.day_qty" />
                                                                                                            </span>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="o_pms_pwa_rb_tab o_pms_pwa_rb_edit" data-toggle="modal" data-target="#o_pms_pwa_editModal" t-attf-data-reservation-id="{{ reservation.id }}" t-attf-data-service-id="{{ i.id }}" t-attf-data-id="{{ s.id }}">
                                                                                                        <div class="o_pms_pwa_rb_spot">
                                                                                                            <span class="o_pms_pwa_rb_txt">
                                                                                                                <i class="fa fa-edit"></i>
                                                                                                            </span>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </td>
                                                                                        <td>
                                                                                            <input type="number" t-attf-data-main_field="service_ids" t-attf-data-subservice_field_id="{{s.id}}" data-subservice_name="service_line_ids" t-attf-data-field_id="{{ i.id }}" t-attf-id="price_{{ i.id }}_{{ s.id }}" name="price_unit"  t-attf-value="{{ s.price_unit }}" class="form-control o_pms_pwa_modal_number" />
                                                                                        </td>
                                                                                    </tr>
                                                                                </t>
                                                                            </tbody>
                                                                        </table>
                                                                        <br />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <!-- <div class="form-check mt-2" t-if="i.service_line_ids==''">
                                                                <input class="o_pms_pwa_checkbox" type="checkbox" id="defaultCheck2" checked="checked" />
                                                                <label class="o_pms_pwa_checkbox_label" for="defaultCheck2">
                                                                    <t t-esc="i.product_id.name" />
                                                                </label>
                                                            </div> -->
                                                        </div>
                                                        <div class="col-12 mt-2">
                                                            <div class="o_roomdoo_hide_show-services-more o_roomdoo_hide_show-more2" t-attf-data-service-id="{{i.id}}">Ver más</div>
                                                        </div>
                                                    </t>
                                                </div>

                                                <div class="row mt-4">
                                                    <div class="col-sm-12">
                                                        <label class="control-label col-12" for="add_service">
                                                            Add service
                                                        </label>
                                                        <select class="form-control o_website_form_input o_domain_leaf_operator_select o_input" name="add_service" style="cursor:pointer;">
                                                            <option t-foreach="reservation._get_allowed_service_ids()" t-as="key" t-att-value="key['id']">
                                                                <t t-esc="key['name']" />
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <hr class="o_pms_pwa_black_hr" />
                                                <div class="row mt-3">
                                                    <div class="col-12 o_pms_pwa_selectpicker">
                                                        <!-- <label class="control-label col-12" for="allowed_segmentations">
                                                            Motivo del viaje
                                                        </label> -->
                                                        <!-- <select multiple="true" data-live-search="true" name="segmentation_ids"  class="selectpicker"> -->

                                                        <select multiple="true" data-style="form-control o_pms_pwa_multiselect" class="selectpicker w-100" data-live-search="true" name="segmentation_ids" title="Segmentation" >
                                                            <!-- t-att-selected="reservation.service_ids in key['id'] ? 'selected' : None" -->
                                                            <option name="segmentation_ids" t-foreach="json_reservation['allowed_segmentations']" t-as="key" t-att-value="key['id']">
                                                                <t t-esc="key['name']" />
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <hr />
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <label class="control-label col-12" for="folio_internal_comment">
                                                            Internal Notes
                                                        </label>
                                                        <input
                                                            t-att-required='"required" if "folio_internal_comment" in required_fields else None'
                                                            t-att-readonly='"readonly" if "folio_internal_comment" in readonly_fields else None'
                                                            class="form-control" type="text" name="folio_internal_comment" t-att-value="reservation.folio_internal_comment"
                                                        />
                                                        <!-- <div class="form-group text-center">
                                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
                                                        </div> -->
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                            </div>
                            <div class="col-lg-12 col-xl-4" id="invoice_col">
                                <div class="card shadow my-4">
                                    <div class="card-header bg-white o_pms_pwa_card_header">
                                        <h3 class="mb-0">
                                            PRECIOS
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <form action="#" method="post" class="form-horizontal">
                                            <div class="form-group form-field mt8">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <label class="control-label col-12" for="allowed_pricelists">
                                                            Tarifa
                                                        </label>
                                                        <select class="form-control o_website_form_input o_domain_leaf_operator_select o_input" name="allowed_pricelists">
                                                            <option name="allowed_pricelists" t-foreach="reservation._get_allowed_pricelists([reservation.pms_property_id.id])" t-as="key" t-att-value="key['id']">
                                                                <t t-esc="key['name']" />
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-sm-12">
                                                        <h4 data-toggle="collapse" data-target="#collapse_price_nights">
                                                            <i class="fa fa-pencil-square-o" aria-hidden="false" />
                                                            Precio/Noche
                                                            <i class="fa fa-angle-down rotate-icon" />
                                                        </h4>
                                                        <div id="collapse_price_nights" class="collapse" aria-labelledby="headingOne">
                                                            <table class="table table-condensed">
                                                                <thead>

                                                                    <tr>
                                                                        <th class="o_pms_pwa_theme_color">Día</th>
                                                                        <th class="o_pms_pwa_theme_color">Precio</th>
                                                                        <th class="o_pms_pwa_theme_color">Descuento (%)</th>
                                                                    </tr>

                                                                </thead>
                                                                <tbody>
                                                                    <t t-foreach="reservation._get_reservation_line_ids()" t-as="i">
                                                                        <tr>
                                                                            <td>
                                                                                <t t-esc="i_value['date']" />
                                                                            </td>
                                                                            <td>
                                                                                <input type="number" name="precio" t-att-value="i_value['price']" class="form-control o_pms_pwa_modal_number" />
                                                                            </td>
                                                                            <td>
                                                                                <input type="number" name="descuento" t-att-value="i_value['discount']" class="form-control o_pms_pwa_modal_number" />
                                                                            </td>
                                                                        </tr>
                                                                    </t>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="card bg-dark shadow">
                                    <div class="card-header o_pms_pwa_card_header">
                                        <h3 class="mb-0">
                                            Detalles de Facturación
                                        </h3>
                                    </div>
                                    <div class="card-body bg-dark">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th class="o_pms_pwa_theme_color"></th>
                                                    <th class="o_pms_pwa_theme_color">concepto</th>
                                                    <th class="o_pms_pwa_theme_color text-right">por facturar</th>
                                                    <th class="o_pms_pwa_theme_color text-right">facturado / total </th>
                                                    <th class="o_pms_pwa_theme_color text-right">importe</th>
                                                </tr>
                                            </thead>
                                            <tbody id="reservation_list"></tbody>
                                        </table>
                                        <!-- <div class="row">
                                            <div class="col-12">
                                                <div class="o_roomdoo_hide_show-more2">Show more</div>
                                            </div>
                                        </div> -->
                                        <div class="row pago-badge">
                                            <div class="col-4">
                                                <span>
                                                    Total
                                                    <br />
                                                    a facturar
                                                </span>
                                                <span class="pt" id="total_amount">
                                                    <t t-esc="reservation.folio_id.amount_total" />
                                                </span>
                                            </div>
                                            <div class="col-4">
                                                <span>
                                                    Total
                                                </span>
                                                <span class="price">
                                                    <t t-esc="reservation.folio_id.amount_total" />
                                                </span>
                                            </div>
                                            <div class="col-4">
                                                <span>
                                                    Pendiente
                                                    <br />
                                                    de pago
                                                </span>
                                                <span class="price2">
                                                    <t t-esc="reservation.folio_id.pending_amount" />
                                                </span>
                                            </div>
                                        </div>

                                            <hr class="m-1" />
                                            <!-- <div class="row pago-badge">
                                            <div class="col-12">Nº tarjeta reserva</div>
                                            <div class="col-12 num">
                                                <t t-esc="reservation.folio_id.credit_card_details" />
                                                **** **** **** 2545
                                            </div>
                                        </div> -->
                                            <div class="row m-1" id="facturacion">
                                                <div class="col-12">
                                                    <h4 data-toggle="collapse" data-target="#collapseDatos" style="cursor: pointer;">
                                                        Contacto de Facturación
                                                        <i class="fa fa-angle-down o_pms_pwa_rotate-icon" />
                                                    </h4>
                                                    <div id="collapseDatos" class="collapse" aria-labelledby="headingOne" data-parent="#facturacion">
                                                        <div class="card-body">
                                                            <form target="_self" t-attf-action="/reservation/{{ reservation.id }}" method="post" class="form-horizontal">
                                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
                                                                <div class="form-group form-field mt8">
                                                                    <div class="row">
                                                                        <div class="col-sm-12">
                                                                            <label class="control-label col-12" for="rate_type">
                                                                            Seleccionar Contacto
                                                                        </label>
                                                                            <select class="form-control o_website_form_input o_domain_leaf_operator_select o_input" id="partner_to_invoice">
                                                                                <t t-foreach="reservation.folio_id.partner_invoice_ids" t-as="partner">
                                                                                    <t t-if="partner.id == reservation.folio_id.partner_id.id">
                                                                                        <option t-attf-value="{{ partner.id }}" selected="selected">
                                                                                            <t t-esc="partner.name"></t>
                                                                                        </option>
                                                                                    </t>
                                                                                    <t t-else="">
                                                                                        <option t-attf-value="{{ partner.id }}">
                                                                                            <t t-esc="partner.name"></t>
                                                                                        </option>
                                                                                    </t>
                                                                                </t>
                                                                                <option value="False">New contact</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <div class="row mt-2 o_pms_pwa_partner_modal_show" t-attf-data-partner-id="{{ reservation.partner_id.id or 0 }}" t-attf-data-reservation-id="{{ reservation.id }}">
                                                                        <span>
                                                                            Editar contacto<i class="col-1 fa fa-pencil-square-o"></i>
                                                                        </span>
                                                                    </div>
                                                                    <div class="row mt-2">
                                                                        <div class="col-sm-12">
                                                                            <label class="control-label col-12" for="rate_type">
                                                                            Nombre
                                                                        </label>
                                                                            <input class="form-control o_pms_pwa_search_partner" type="text" name="invoice_name" t-attf-value="{{ reservation.folio_id.partner_id.name }}" />
                                                                            <input type="hidden" name="partner_id" t-attf-value="{{ reservation.folio_id.partner_id.id }}" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="row mt-2">
                                                                        <div class="col-sm-12">
                                                                            <label class="control-label col-12" for="rate_type">
                                                                            NIF/CIF
                                                                        </label>
                                                                            <input class="form-control" type="text" name="invoice_vat" t-attf-value="{{ reservation.folio_id.partner_id.vat }}" required="required" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="row mt-2">
                                                                        <div class="col-sm-12">
                                                                            <label class="control-label col-12" for="rate_type">
                                                                            Dirección
                                                                        </label>
                                                                            <input class="form-control" type="text" name="invoice_street" t-attf-value="{{ reservation.folio_id.partner_id.street }}" required="required" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="row mt-2">
                                                                        <div class="col-sm-12">
                                                                            <label class="control-label col-12" for="rate_type">
                                                                            Ciudad
                                                                        </label>
                                                                            <input class="form-control" type="text" name="invoice_city" t-attf-value="{{ reservation.folio_id.partner_id.city }}" required="required" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="row mt-2">
                                                                        <div class="col-sm-12">
                                                                            <label class="control-label col-12" for="rate_type">
                                                                            Código Postal
                                                                        </label>
                                                                            <input class="form-control" type="text" name="invoice_postal_code" t-attf-value="{{ reservation.folio_id.partner_id.zip }}" required="required" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="row mt-2">
                                                                        <div class="col-sm-12">
                                                                            <label class="control-label col-12" for="rate_type">
                                                                            País
                                                                        </label>
                                                                            <input class="form-control o_pms_pwa_search_country_name" type="text" name="invoice_country" t-attf-value="{{ reservation.folio_id.partner_id.country_id.name }}" required="required" />
                                                                            <input type="hidden" name="country_id" t-attf-value="{{ reservation.folio_id.partner_id.country_id.id }}" />
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- <input type="submit" class="btn btn-message" value="Actualizar" /> -->
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- <div class="row m-1">
                                                <div class="col-12">
                                                    <h4>Payment methods</h4>
                                                </div>
                                                <div class="col-12">
                                                    <t t-foreach="reservation.folio_id.pms_property_id._get_payment_methods()" t-as="payment">

                                                        <div class="form-check mt-1">
                                                            <input type="radio" class="o_pms_pwa_checkbox" name="payment_method" t-attf-value="{{ payment.id }}" checked="checked" />
                                                            <label class="o_pms_pwa_checkbox_label pl-1">
                                                                <t t-esc="payment.name"></t>
                                                            </label>
                                                        </div>

                                                    </t>
                                                </div>
                                            </div> -->

                                            <hr class="m-1" />
                                            <div class="col-12">
                                                <div class="form-group text-center">
                                                    <!-- <button class="btn btn-print">
                                                    <i class="fa fa-print" aria-hidden="false" />
                                                    IMPRIMIR
                                                </button> -->

                                                    <button id="invoice_button" class="btn btn-message">
                                                        <i class="fa fa-file-text-o" aria-hidden="false" />
                                                        Facturar
                                                    </button>

                                                </div>
                                            </div>

                                    </div>
                                </div>
                                <t t-if="reservation.folio_id.invoice_count > 0">
                                    <div class="card bg-white shadow mt-4">
                                        <div class="card-header bg-white o_pms_pwa_card_header">
                                            <h3 class="mb-0">
                                                Facturas
                                            </h3>
                                        </div>
                                        <div class="card-body bg-white o_pms_pwa_table_reservation_list">
                                            <table class="table">
                                                <thead>

                                                    <tr>
                                                        <th class="o_pms_pwa_theme_color">Factura</th>
                                                        <th class="o_pms_pwa_theme_color">Cliente</th>
                                                        <th class="o_pms_pwa_theme_color">Fecha</th>
                                                        <th class="o_pms_pwa_theme_color">Total</th>
                                                    </tr>

                                                </thead>
                                                <tbody>
                                                    <t t-foreach="reservation.folio_id.move_ids" t-as="i">
                                                        <tr>
                                                            <td>
                                                                <a class="o_pms_pwa_theme_color" t-att-href="'/my/invoices/' + str(i.id)">
                                                                    <t t-esc="i.name" />
                                                                </a>
                                                            </td>
                                                            <td class="black_text">
                                                                <t t-esc="i.partner_id.name" />
                                                            </td>
                                                            <td class="black_text text-right">
                                                                <t t-esc="i.invoice_date" />
                                                            </td>
                                                            <td class="black_text text-right">
                                                                <t t-esc="i.amount_total" />
                                                            </td>

                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </t>

                                <div class="card bg-dark shadow mt-4">
                                    <div class="card-header o_pms_pwa_card_header">
                                        <h3 class="mb-0">
                                            Listado de pagos
                                        </h3>
                                    </div>
                                    <div class="card-body bg-dark">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th class="o_pms_pwa_theme_color"></th>
                                                    <th class="o_pms_pwa_theme_color">método de pago</th>
                                                    <th class="o_pms_pwa_theme_color text-right">fecha</th>
                                                    <th class="o_pms_pwa_theme_color text-right">importe</th>
                                                </tr>
                                            </thead>
                                            <tbody id="payments_list"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

        </t>
    </template>
</odoo>
